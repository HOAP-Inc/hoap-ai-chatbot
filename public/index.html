<body>
  <!-- ランチャーだけは外に置く（サイトJSに干渉されないよう最小） -->
  <button class="hoap-chat-launcher" aria-label="チャットを開く">💬</button>

  <script>
    // Shadow Root を作って、その中にチャットHTMLとCSSを全部入れる
    const mount = document.createElement('div');
    document.body.appendChild(mount);
    const shadow = mount.attachShadow({ mode: 'open' });

    // チャットの中身（元のCSS/HTML/JSをほぼそのまま）
    const tpl = document.createElement('template');
    tpl.innerHTML = `
      <style>
        :host {
  all: initial;
  --z: 2147483000;
  --radius: 16px;
  --shadow: 0 8px 24px rgba(0,0,0,.18);
  --bg: #ffffff;
  --grad1: #f9a8d4;
  --grad2: #d8b4fe;
  --grad3: #c4b5fd;
}
        * { box-sizing: border-box; font: inherit; }
        .hoap-chat-launcher {
          position: fixed; right: 20px; bottom: 20px; z-index: var(--z);
          width: 64px; height: 64px; border-radius: 999px; border: none; cursor: pointer;
          background: linear-gradient(135deg, var(--grad1), var(--grad2), var(--grad3));
          color: #fff; font-size: 24px; display: grid; place-items: center;
          box-shadow: var(--shadow);
        }
        .hoap-chat {
  position: fixed; right: 20px; bottom: 100px; z-index: var(--z);
  width: 360px; max-width: calc(100vw - 40px);
  background: var(--bg); border-radius: var(--radius); box-shadow: var(--shadow);
  border: 1px solid #e5e7eb; isolation: isolate;
  display: none; flex-direction: column; overflow: hidden;
  max-height: 100vh; height: auto;
}

/* PC専用 */
@media (min-width: 769px) {
  .hoap-chat {
    top: 30px;      /* これを入れると高さがぐっと広がる */
    bottom: 20px;
    height: auto;
    max-height: none;
  }
}
√

/* スマホ画面のときに上書き */
@media (max-width: 480px) {
  .hoap-chat {
    right: 0;
    bottom: 0;
    width: 100%;
    max-height: 100vh;
    height: 100vh;
    border-radius: 0;
  }
}
        .open { display: flex; }
        .hoap-chat-header {
          padding: 12px 14px;
          background: linear-gradient(135deg, var(--grad1), var(--grad2), var(--grad3));
          color: #fff; display: flex; align-items: center; gap: 10px;
        }
        .title { font-weight: 700; font-size: 14px; }
        .sub { font-size: 12px; opacity: .9; }
        .hoap-chat-close { margin-left: auto; background: transparent; color: #fff; border: none; font-size: 18px; cursor: pointer; }
        .hoap-chat-body {
          padding: 12px; overflow-y: auto; background: #fafafa;
          position: relative; z-index: 0;
          padding-bottom: calc(12px + var(--uiH, 0px));
          flex: 1; min-height: 0;
        }
        .msg { display: flex; gap: 8px; margin-bottom: 10px; position: relative; z-index: 2; }
        .user { justify-content: flex-end; }
        .bubble { padding: 10px 12px; border-radius: 14px; max-width: 80%; line-height: 1.4; font-size: 14px; }
        .bot .bubble { background: #fff; border: 1px solid #e5e7eb; }
        .user .bubble { background: linear-gradient(135deg, var(--grad1), var(--grad2), var(--grad3)); color: #fff; }
        .hoap-quick { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 12px; border-top: 1px solid #e5e7eb; background: #fff; }
        .hoap-quick button { border: 1px solid #e5e7eb; background: #fff; border-radius: 999px; padding: 6px 10px; font-size: 12px; cursor: pointer; }
        .hoap-chat-input { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #e5e7eb; background: #fff; }
        .hoap-chat-input textarea { flex: 1; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; font-size: 14px; resize: none; }
        .hoap-chat-input button { background: linear-gradient(135deg, var(--grad1), var(--grad2), var(--grad3)); color: #fff; border: none; padding: 0 14px; border-radius: 10px; cursor: pointer; }
        .mascot{
          position: absolute; right: 8px; bottom: 20px;
          width: min(78%, 300px); pointer-events: none; z-index: 1;
          filter: drop-shadow(0 10px 24px rgba(0,0,0,.22)); opacity: .98;
          transform: translateY(var(--scrollY, 0px));
        }
        .mascot-sprite{ display: block; width: 100%; height: auto; animation: floaty 4.8s ease-in-out infinite; }
        @keyframes floaty { 0% { transform: translateY(0) rotate(0.4deg);} 50% { transform: translateY(-8px) rotate(-0.4deg);} 100% { transform: translateY(0) rotate(0.4deg);} }
        @media (prefers-reduced-motion: reduce) { .mascot-sprite { animation: none; } }
        @media (max-width: 480px){
          .hoap-chat{ width: 300px; right: 12px; bottom: 76px; max-width: calc(100vw - 24px); }
          .bubble{ font-size: 13px; }
          .hoap-chat-input textarea{ font-size: 13px; }
          .mascot{ width: min(65%, 220px); bottom: 12px; }
        }
        @media (max-width: 360px){ .hoap-chat{ width: 280px; right: 10px; bottom: 72px; } .bubble{ font-size: 12px; } }
      </style>

      <button class="hoap-chat-launcher" aria-label="チャットを開く">💬</button>

      <div class="hoap-chat" role="dialog" aria-label="HOAP サイトチャット">
        <div class="hoap-chat-header">
          <div>
            <div class="title">HOAP-chan</div>
            <div class="sub">医療・歯科・介護業界特化 採用支援</div>
          </div>
          <button class="hoap-chat-close" aria-label="閉じる">×</button>
        </div>

        <div class="hoap-chat-body" id="chatBody">
          <div class="mascot" aria-hidden="true">
            <img class="mascot-sprite" src="/hoap-basic.png" alt="HOAP-chan">
          </div>
        </div>

        <div class="hoap-quick" id="quickArea">
          <button data-intent="about">サービス概要</button>
          <button data-intent="trend">採用トレンド</button>
          <button data-intent="challenge">採用課題</button>
          <button data-intent="solution">HOAPの解決法</button>
          <button data-intent="feature">支援の特徴</button>
          <button data-intent="insta">Instagram運用</button>
          <button data-intent="cases">事例紹介</button>
          <button data-intent="price">料金</button>
          <button data-intent="flow">導入フロー</button>
          <button data-intent="contact">問い合わせ</button>
        </div>

        <div class="hoap-chat-input">
          <textarea id="chatInput" rows="2" placeholder="質問を入力して送信"></textarea>
          <button id="sendBtn">送信</button>
        </div>
      </div>
    `;

    shadow.appendChild(tpl.content.cloneNode(true));

    // ここから中の要素は shadow 内から取得（外のJSは触れない）
    const $ = sel => shadow.querySelector(sel);
    const bodyEl   = $('#chatBody');
    const inputEl  = $('#chatInput');
    const sendBtn  = $('#sendBtn');
    const quickEl  = $('#quickArea');
    const launcher = shadow.querySelector('.hoap-chat-launcher');
    const dialog   = shadow.querySelector('.hoap-chat');
    const closeBtn = shadow.querySelector('.hoap-chat-close');

    function placeMascot() {
      const mascot = shadow.querySelector('.mascot');
      if (!mascot) return;
      mascot.style.setProperty('bottom', '12px', 'important');
    }
    function syncMascotWithScroll(){
      const mascot = shadow.querySelector('.mascot');
      if(!mascot) return;
      mascot.style.setProperty('--scrollY', bodyEl.scrollTop + 'px');
    }

    const KB = {
      about: 'HOAPは医療・歯科・介護業界に特化した採用支援サービスを提供しているよ。求人媒体＋SNS運用を代行し、手間なく欲しい人材から応募を集めるのが得意なんだ！',
      trend: '求職者は応募前にSNSで情報収集する時代。求職者の8割がSNSで気になる会社を検索し、職場の雰囲気や人間関係を確認してから応募するんだ。',
      challenge: 'よく相談される課題は「応募が来ない」「時間がない」「離職が多い」。診療や訪問に追われ、採用に手が回らない経営者も多いんだ。',
      solution: 'HOAPは業界特化のノウハウで応募を集め、媒体の運用・スカウト・面接日調整、採用広報のSNS運用など実務まで代行しているよ。経営者や事務スタッフはコア業務に専念できるんだ！',
      feature: '特徴は3つ。①欲しい人材像を明確化 ②媒体運用やスカウト送付を代行 ③毎月データ分析と改善提案',
      insta: 'Instagram運用支援では、他社との差別化×求職者に共感される投稿を設計し、ファン化を狙うよ。お客様は写真の提供とアンケートの回答、投稿前のチェックだけでいいんだ！',
      cases: '事例① 兵庫県の訪問看護ステーション様では人事部門をアウトソーシングして応募が増加。事例②千葉県の介護事業所様ではなんと応募数が2.5倍に。　事例③東京都の訪問看護ステーション様では求職者からDMで応募が来たり面接で「インスタを見て応募を決めました」という声もあるんだ。',
      price: '採用支援は月額10万円〜（求人数・期間により変動）。Instagram運用支援は月額15万円。初期費用は各10万円で提供しているよ！',
      flow: '導入フローは ①無料相談 ②契約 ③キックオフMTG ④支援開始。最短3営業日で着手可能だよ！',
    };

    function addMsg(side, text) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + side;
      const bub = document.createElement('div');
      bub.className = 'bubble';
      bub.textContent = text;
      wrap.appendChild(bub);
      bodyEl.appendChild(wrap);
      bodyEl.scrollTop = bodyEl.scrollHeight;
      placeMascot();
      syncMascotWithScroll();
    }
    const botSay  = t => addMsg('bot', t);
    const userSay = t => addMsg('user', t);

    function answer(intent) {
      const btn = quickEl.querySelector('[data-intent="' + intent + '"]');
      if (btn) userSay(btn.textContent);
      botSay(KB[intent] || 'その話題は用意してないやつ。サービスについてなら案内できるよ。');
    }

    function topicKey(text){
      const t = text.replace(/\s+/g,'').toLowerCase();
      if (t.includes('料金')||t.includes('price')) return 'price';
      if (t.includes('導入')||t.includes('flow')||t.includes('始め')) return 'flow';
      if (t.includes('事例')||t.includes('case')) return 'cases';
      if (t.includes('インスタ')||t.includes('instagram')) return 'insta';
      if (t.includes('求人')||t.includes('採用')||t.includes('広報')) return 'recruit';
      return 'service';
    }
    let lastTopic = ''; let sameCount = 0;
    function afterBotReply(userText){
      const k = topicKey(userText);
      if (k === lastTopic) sameCount += 1; else { lastTopic = k; sameCount = 1; }
      if (sameCount >= 2) { botSay('よかったらHOAPに相談してみない？問い合わせフォームを押してね！'); sameCount = 0; }
    }

    const API_ORIGIN = 'https://hoap-ai-chatbot.vercel.app';

    async function ask(question) {
      const res = await fetch('/api/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: question }),
      });
      let data = null;
      try { data = await res.json(); } catch {}
      if (!res.ok) {
        const msg = (data && (data.detail || data.error)) || res.status + ' ' + res.statusText;
        throw new Error(msg);
      }
      if (data && data.error) { throw new Error(data.detail || data.error); }
      return (data && data.reply) ? data.reply : '';
    }

    async function handleInput() {
      const raw = inputEl.value;
      const text = raw.trim();
      if (!text) return;
      userSay(text);
      inputEl.value = '';
      setTimeout(() => { inputEl.value = ''; inputEl.focus(); }, 0);
      try {
        const a = await ask(text);
        botSay(a || '（空の返答）');
        afterBotReply(text);
      } catch (e) {
        botSay('エラー: ' + (e && e.message ? e.message : e));
      }
    }

    sendBtn.addEventListener('click', () => { handleInput(); });
    let composing = false;
    inputEl.addEventListener('compositionstart', () => { composing = true; });
    inputEl.addEventListener('compositionend',   () => { composing = false; });
    inputEl.addEventListener('keydown', e => {
      if (composing) return;
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        handleInput();
      }
    });

    quickEl.addEventListener('click', e => {
      const btn = e.target.closest('button'); if (!btn) return;
      const intent = btn.dataset.intent; if (!intent) return;
      if (intent === 'contact') { window.location.href = 'https://hoap-inc.jp/contact'; return; }
      answer(intent);
      afterBotReply(btn.textContent);
    });

    function openChat() {
      dialog.classList.add('open');
      if (!bodyEl.dataset.welcomed) {
        botSay('こんにちは！ほーぷちゃんだよ。気になるところをタップしてね！');
        bodyEl.dataset.welcomed = '1';
      }
      placeMascot();
      syncMascotWithScroll();
      inputEl.focus();
    }
    function closeChat() { dialog.classList.remove('open'); }

    // Shadow内のランチャーを使う（外にあるボタンは無視してOK）
    const outerLauncher = document.querySelector('.hoap-chat-launcher');
    if (outerLauncher) outerLauncher.style.display = 'none'; // 外のは非表示

    const innerLauncher = shadow.querySelector('.hoap-chat-launcher');
    innerLauncher.addEventListener('click', openChat);
    closeBtn.addEventListener('click', closeChat);
    window.addEventListener('resize', placeMascot);
    bodyEl.addEventListener('scroll', syncMascotWithScroll);
  </script>
</body>
