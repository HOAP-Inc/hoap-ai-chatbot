<body>
  <!-- ãƒ©ãƒ³ãƒãƒ£ãƒ¼ã ã‘ã¯å¤–ã«ç½®ãï¼ˆã‚µã‚¤ãƒˆJSã«å¹²æ¸‰ã•ã‚Œãªã„ã‚ˆã†æœ€å°ï¼‰ -->
  <button class="hoap-chat-launcher" aria-label="ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã">ğŸ’¬</button>

  <script>
    // Shadow Root ã‚’ä½œã£ã¦ã€ãã®ä¸­ã«ãƒãƒ£ãƒƒãƒˆHTMLã¨CSSã‚’å…¨éƒ¨å…¥ã‚Œã‚‹
    const mount = document.createElement('div');
    document.body.appendChild(mount);
    const shadow = mount.attachShadow({ mode: 'open' });

    // ãƒãƒ£ãƒƒãƒˆã®ä¸­èº«ï¼ˆå…ƒã®CSS/HTML/JSã‚’ã»ã¼ãã®ã¾ã¾ï¼‰
    const tpl = document.createElement('template');
    tpl.innerHTML = `
      <style>
        :host {
  all: initial;
  --z: 2147483000;
  --radius: 16px;
  --shadow: 0 8px 24px rgba(0,0,0,.18);
  --bg: #ffffff;
  --grad1: #f9a8d4;
  --grad2: #d8b4fe;
  --grad3: #c4b5fd;
}
* { box-sizing: border-box; font: inherit; }

.hoap-chat-launcher{
  position: fixed;
  right: 20px;
  bottom: 80px;              /* ä½ç½®ã¯ã“ã“ã§èª¿æ•´ */
  z-index: var(--z);
  width: 128px;              /* ç”»åƒã‚µã‚¤ã‚º */
  height: auto;
  background: transparent;   /* ã‚°ãƒ©ãƒ‡å‰Šé™¤ */
  border: none;
  padding: 0;
  display: block;
  box-shadow: none;
  cursor: pointer;
}
.hoap-chat-launcher img{
  display: block;
  width: 100%;
  height: auto;
  pointer-events: none;
  animation: floaty 4.8s ease-in-out infinite;  /* ãµã‚ãµã‚ */
}
@media (max-width: 480px){
  .hoap-chat-launcher{ right:12px; bottom:72px; width:100px; }
}

/* ãƒãƒ£ãƒƒãƒˆå…¨ä½“ï¼šã¡ã‚‡ã„å°ã•ãï¼†é«˜ã•ã¯å¸¸ã«80vhã§å®‰å®š */
.hoap-chat {
  position: fixed; right: 15px; bottom: 20px; z-index: var(--z); /* 20px -> 15px */
  width: 360px;                                   /* 320px -> 360px */
  max-width: calc(100vw - 30px);
  background: var(--bg); border-radius: var(--radius); box-shadow: var(--shadow);
  border: 1px solid #e5e7eb; isolation: isolate;
  display: none;                                   /* .openã§display:flexã«ãªã‚‹ */
  flex-direction: column; overflow: hidden;
  height: 72vh;                                    /* â† é«˜ã•å›ºå®š */
  max-height: 80vh;
}

.hoap-chat.open { display: flex; }   /* ãƒãƒ£ãƒƒãƒˆã«ã ã‘åŠ¹ã‹ã›ã‚‹ */

.hoap-chat-header {
  padding: 12px 14px;
  background: linear-gradient(135deg, var(--grad1), var(--grad2), var(--grad3));
  color: #fff; display: flex; align-items: center; gap: 10px;
}
.title { font-weight: 700; font-size: 14px; }
.sub { font-size: 12px; opacity: .9; }
.hoap-chat-close { margin-left: auto; background: transparent; color: #fff; border: none; font-size: 18px; cursor: pointer; }

.hoap-chat-body {
  padding: 12px; overflow-y: auto; background: #fafafa;
  position: relative; z-index: 0;
  padding-bottom: calc(12px + var(--uiH, 0px));
  flex: 1; min-height: 0;
}

.msg { display: flex; gap: 8px; margin-bottom: 10px; position: relative; z-index: 2; }
.user { justify-content: flex-end; }
.bubble { padding: 10px 12px; border-radius: 14px; max-width: 80%; line-height: 1.4; font-size: 14px; white-space: pre-wrap; }
.bot .bubble { background: #fff; border: 1px solid #e5e7eb; max-width: 65%; } /* ã»ãƒ¼ã·ã¡ã‚ƒã‚“ãŒè¦‹ãˆã‚‹ã‚ˆã†å¹…ã‚’ç‹­ã‚ã‚‹ */
.user .bubble { background: linear-gradient(135deg, var(--grad1), var(--grad2), var(--grad3)); color: #fff; }
.bubble a { color: #6366f1; text-decoration: underline; }
.bubble a:hover { color: #4f46e5; }

/* é¸æŠè‚¢ãƒœã‚¿ãƒ³ï¼ˆæ–™é‡‘ãªã©ï¼‰ */
.choice-btn {
  display: block;               /* ãƒ–ãƒ­ãƒƒã‚¯ã«ã—ã¦ç¸¦ç©ã¿ */
  width: 90%;                   /* å¹…ã‚’çµ±ä¸€ï¼ˆè¦ªã®90%ï¼‰ */
  max-width: 280px;
  margin: 6px auto;             /* ä¸Šä¸‹ä½™ç™½ï¼‹å·¦å³ä¸­å¤® */
  padding: 8px 12px;
  background: #fff;
  color: #333;
  border: 2px solid #8b5cf6;
  border-radius: 999px;
  font-size: 13px;
  text-align: center;           /* æ–‡å­—çœŸã‚“ä¸­å¯„ã› */
  cursor: pointer;
  transition: background 0.2s;
}
.choice-btn:hover {
  background: #f5f3ff;
}

.hoap-quick {
  display: grid;                       /* Gridã«å¤‰æ›´ */
  grid-template-columns: repeat(3, 1fr); /* 3åˆ—å›ºå®š */
  gap: 8px;
  padding: 10px 12px;
  border-top: 1px solid #e5e7eb;
  background: #fff;
}
.hoap-quick button {
  border: 1px solid #e5e7eb;
  background: #fff;
  border-radius: 999px;
  padding: 8px 4px;                    /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ */
  font-size: 11px;                     /* å°‘ã—å°ã•ãã—ã¦åã‚ã‚‹ */
  cursor: pointer;
  width: 100%;
  display: flex; justify-content: center; align-items: center; /* ãƒœã‚¿ãƒ³å†…ä¸­å¤®å¯„ã› */
}
.hoap-chat-input { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #e5e7eb; background: #fff; }
.hoap-chat-input textarea { flex: 1; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; font-size: 14px; resize: none; }
.hoap-chat-input button { background: linear-gradient(135deg, var(--grad1), var(--grad2), var(--grad3)); color: #fff; border: none; padding: 0 14px; border-radius: 10px; cursor: pointer; }

/* ã»ãƒ¼ã·ã¡ã‚ƒã‚“ï¼šPCã¯æ§ãˆã‚ï¼å³ä¸‹å›ºå®š */
.mascot{
  position: absolute; right: -30px;
  bottom: calc(0px + var(--uiH, 130px)); /* 12px -> 0px, right -16 -> -30 */
  width: min(41%, 147px);
  pointer-events: none; z-index: 1;
  filter: drop-shadow(0 10px 24px rgba(0,0,0,.22)); opacity: .98;
  transform: translateY(var(--scrollY, 0px));
}
.mascot-sprite{ display: block; width: 100%; height: auto; animation: floaty 4.8s ease-in-out infinite; }
@keyframes floaty { 0% { transform: translateY(0) rotate(0.4deg);} 50% { transform: translateY(-8px) rotate(-0.4deg);} 100% { transform: translateY(0) rotate(0.4deg);} }
@media (prefers-reduced-motion: reduce) { .mascot-sprite { animation: none; } }

  /* ã‚¹ãƒãƒ›ï¼šå…¨é«˜ãƒ»å…¨å¹…ã€ã»ãƒ¼ã·ã¡ã‚ƒã‚“ã•ã‚‰ã«å°ã•ãå³ä¸‹ */
  @media (max-width: 480px){
    .hoap-chat{
      right: 0; bottom: 0; width: 100%;
      height: 100vh; max-height: 100vh; border-radius: 0;
    }
    .mascot{
      right: -20px;
      bottom: calc(0px + var(--uiH, 130px)); /* ã‚¹ãƒãƒ›ã‚‚åŒæ§˜ */
      width: min(45%, 140px);
    }
    .hoap-quick button {
      font-size: 10px;
      padding: 6px 2px;
    }
  }
      </style>

      <button class='hoap-chat-launcher' aria-label='ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã'>
  <img src='/hoap-question.png' alt='HOAP-chan'>
</button>

      <div class="hoap-chat" role="dialog" aria-label="HOAP ã‚µã‚¤ãƒˆãƒãƒ£ãƒƒãƒˆ" style="display:none">
        <div class="hoap-chat-header">
          <div>
            <div class="title">HOAP-chan</div>
            <div class="sub">åŒ»ç™‚ãƒ»æ­¯ç§‘ãƒ»ä»‹è­·æ¥­ç•Œç‰¹åŒ– æ¡ç”¨æ”¯æ´</div>
          </div>
          <button class="hoap-chat-close" aria-label="é–‰ã˜ã‚‹">Ã—</button>
        </div>

        <div class="hoap-chat-body" id="chatBody">
          <div class="mascot" aria-hidden="true">
            <img class="mascot-sprite" src="/hoap-basic.png" alt="HOAP-chan">
          </div>
        </div>

        <div class="hoap-quick" id="quickArea">
          <button data-intent="about">ã‚µãƒ¼ãƒ“ã‚¹ç´¹ä»‹</button>
          <button data-intent="cases">äº‹ä¾‹ç´¹ä»‹</button>
          <button data-intent="price">æ–™é‡‘</button>
          <button data-intent="flow">å°å…¥ãƒ•ãƒ­ãƒ¼</button>
          <button data-intent="other">ãã®ä»–è³ªå•</button>
          <button data-intent="contact">å•ã„åˆã‚ã›</button>
        </div>

        <div class="hoap-chat-input">
          <textarea id="chatInput" rows="2" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦é€ä¿¡"></textarea>
          <button id="sendBtn">é€ä¿¡</button>
        </div>
      </div>
    `;

    shadow.appendChild(tpl.content.cloneNode(true));

    // ã“ã“ã‹ã‚‰ä¸­ã®è¦ç´ ã¯ shadow å†…ã‹ã‚‰å–å¾—ï¼ˆå¤–ã®JSã¯è§¦ã‚Œãªã„ï¼‰
    const $ = sel => shadow.querySelector(sel);
    const bodyEl   = $('#chatBody');
    const inputEl  = $('#chatInput');
    const sendBtn  = $('#sendBtn');
    const quickEl  = $('#quickArea');
    const launcher = shadow.querySelector('.hoap-chat-launcher');
    const dialog   = shadow.querySelector('.hoap-chat');
    dialog.classList.remove('open');
    dialog.style.display = 'none';

    const closeBtn = shadow.querySelector('.hoap-chat-close');
    function placeMascot() {
      const mascot = shadow.querySelector('.mascot');
      if (!mascot) return;
      // JSã§ã®å¼·åˆ¶ä½ç½®æŒ‡å®šã‚’è§£é™¤ï¼ˆCSSã«ä»»ã›ã‚‹ï¼‰
      // mascot.style.setProperty('bottom', '12px', 'important');
    }
    function syncMascotWithScroll(){
      const mascot = shadow.querySelector('.mascot');
      if(!mascot) return;
      mascot.style.setProperty('--scrollY', bodyEl.scrollTop + 'px');
    }

    const KB = {
      about: 'HOAPã¯åŒ»ç™‚ãƒ»æ­¯ç§‘ãƒ»ä»‹è­·æ¥­ç•Œã«ç‰¹åŒ–ã—ãŸæ¡ç”¨æ”¯æ´ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã¦ã„ã‚‹ã‚ˆã€‚æ±‚äººåª’ä½“ï¼‹SNSé‹ç”¨ã‚’ä»£è¡Œã—ã€æ‰‹é–“ãªãæ¬²ã—ã„äººæã‹ã‚‰å¿œå‹Ÿã‚’é›†ã‚ã‚‹ã®ãŒå¾—æ„ãªã‚“ã ï¼',
      cases: 'äº‹ä¾‹â‘  å…µåº«çœŒã®è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ§˜ã§ã¯äººäº‹éƒ¨é–€ã‚’ã‚¢ã‚¦ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã—ã¦å¿œå‹ŸãŒå¢—åŠ ã€‚äº‹ä¾‹â‘¡åƒè‘‰çœŒã®ä»‹è­·äº‹æ¥­æ‰€æ§˜ã§ã¯ãªã‚“ã¨å¿œå‹Ÿæ•°ãŒ2.5å€ã«ã€‚ã€€äº‹ä¾‹â‘¢æ±äº¬éƒ½ã®è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ§˜ã§ã¯æ±‚è·è€…ã‹ã‚‰DMã§å¿œå‹ŸãŒæ¥ãŸã‚Šé¢æ¥ã§ã€Œã‚¤ãƒ³ã‚¹ã‚¿ã‚’è¦‹ã¦å¿œå‹Ÿã‚’æ±ºã‚ã¾ã—ãŸã€ã¨ã„ã†å£°ã‚‚ã‚ã‚‹ã‚“ã ã€‚',
      price: 'æ¡ç”¨æ”¯æ´ã¯æœˆé¡10ä¸‡å††ã€œï¼ˆæ±‚äººæ•°ãƒ»æœŸé–“ã«ã‚ˆã‚Šå¤‰å‹•ï¼‰ã€‚Instagramé‹ç”¨æ”¯æ´ã¯æœˆé¡15ä¸‡å††ã€‚åˆæœŸè²»ç”¨ã¯å„10ä¸‡å††ã§æä¾›ã—ã¦ã„ã‚‹ã‚ˆï¼',
      price_recruit: 'æ¡ç”¨æ”¯æ´ã‚µãƒ¼ãƒ“ã‚¹ã¯æœˆé¡110,000å††ï¼ˆç¨è¾¼ï¼‰ã‹ã‚‰å°å…¥å¯èƒ½ã ã‚ˆï¼<br>ç¾åœ¨ã®èª²é¡Œæ„Ÿã‚„æ¡ç”¨è¨ˆç”»ã«åˆã‚ã›ã¦æŸ”è»Ÿã«å¯¾å¿œã§ãã‚‹ã‹ã‚‰ã€ã‚ˆã‹ã£ãŸã‚‰ã¾ãšã¯ç›¸è«‡ã—ã¦ã¿ã¦ã­ã€‚<br><button class="choice-btn" data-next="contact_direct">å•ã„åˆã‚ã›</button>',
      price_insta: 'æ¡ç”¨æ”¯æ´ã‚µãƒ¼ãƒ“ã‚¹ã¯æœˆé¡165,000å††ï¼ˆç¨è¾¼ï¼‰ã§å°å…¥å¯èƒ½ã ã‚ˆï¼<br>ç¾åœ¨ã®èª²é¡Œæ„Ÿã‚„æ¡ç”¨è¨ˆç”»ã«åˆã‚ã›ã¦æŸ”è»Ÿã«å¯¾å¿œã§ãã‚‹ã‹ã‚‰ã€ã‚ˆã‹ã£ãŸã‚‰ã¾ãšã¯ç›¸è«‡ã—ã¦ã¿ã¦ã­ã€‚<br><button class="choice-btn" data-next="contact_direct">å•ã„åˆã‚ã›</button>',
      contact_direct: 'contact',  /* ç‰¹åˆ¥ãªã‚­ãƒ¼ã¨ã—ã¦æ‰±ã† */
      flow: 'å°å…¥ãƒ•ãƒ­ãƒ¼ã¯ â‘ ç„¡æ–™ç›¸è«‡ â‘¡å¥‘ç´„ â‘¢ã‚­ãƒƒã‚¯ã‚ªãƒ•MTG â‘£æ”¯æ´é–‹å§‹ã€‚æœ€çŸ­3å–¶æ¥­æ—¥ã§ç€æ‰‹å¯èƒ½ã ã‚ˆï¼',
      other: 'ãã®ä»–ã®ã”è³ªå•ã«ã¤ã„ã¦ã¯ã€ãŠæ°—è»½ã«å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã”é€£çµ¡ãã ã•ã„ã€‚è©³ã—ããŠç­”ãˆã—ã¾ã™ã­ï¼',
    };

    function addMsg(side, text, isHtml = false) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + side;
      const bub = document.createElement('div');
      bub.className = 'bubble';
      if (isHtml) {
        bub.innerHTML = text;
      } else {
        bub.textContent = text;
      }
      wrap.appendChild(bub);
      bodyEl.appendChild(wrap);
      bodyEl.scrollTop = bodyEl.scrollHeight;
      placeMascot();
      syncMascotWithScroll();
    }
    const botSay  = (t, isHtml = false) => addMsg('bot', t, isHtml);
    const userSay = t => addMsg('user', t);

    function answer(intent) {
      const btn = quickEl.querySelector('[data-intent="' + intent + '"]');
      if (btn) userSay(btn.textContent);
      
      if (intent === 'cases') {
        botSay('ã“ã¡ã‚‰ã‹ã‚‰ç¢ºèªã—ã¦ã­ï¼<br><button class="choice-btn" data-link="https://hoap-inc.jp/case">å°å…¥äº‹ä¾‹ç´¹ä»‹</button>', true);
      } else if (intent === 'price') {
        botSay('ã©ã¡ã‚‰ã®æ–™é‡‘ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ï¼Ÿ<br>' +
          '<button class="choice-btn" data-next="price_recruit">æ¡ç”¨æ”¯æ´</button>' +
          '<button class="choice-btn" data-next="price_insta">æ¡ç”¨åºƒå ±æ”¯æ´</button>', true);
      } else if (intent === 'about') {
        botSay('ã©ã¡ã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ï¼Ÿ<br>' +
          '<button class="choice-btn" data-ask="æ¡ç”¨æ”¯æ´ã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦">æ¡ç”¨æ”¯æ´</button>' +
          '<button class="choice-btn" data-ask="æ¡ç”¨åºƒå ±æ”¯æ´ã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦">æ¡ç”¨åºƒå ±æ”¯æ´</button>', true);
      } else {
        botSay(KB[intent] || 'ãã®è©±é¡Œã¯ç”¨æ„ã—ã¦ãªã„ã‚„ã¤ã€‚ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦ãªã‚‰æ¡ˆå†…ã§ãã‚‹ã‚ˆã€‚');
      }
    }
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã®é¸æŠãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    bodyEl.addEventListener('click', async e => {
      const btn = e.target.closest('.choice-btn');
      if (!btn) return;
      const next = btn.dataset.next;
      const askText = btn.dataset.ask;
      const link = btn.dataset.link; // è¿½åŠ 

      if (link) {
        window.open(link, '_blank');
        return;
      }
      
      if (next === 'contact_direct') {
        window.location.href = 'https://hoap-inc.jp/contact';
        return;
      }

      if (askText) {
        userSay(btn.textContent);
        try {
           const tempId = 'temp-' + Date.now();
           botSay('<span id="' + tempId + '">â€¦</span>', true);
           const reply = await ask(askText);
           const tempEl = shadow.getElementById(tempId);
           if (tempEl) tempEl.closest('.msg').remove(); 
           
           await splitAndShow(reply);
           // å›ç­”å¾Œã«å•ã„åˆã‚ã›ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆã‚µãƒ¼ãƒ“ã‚¹ç´¹ä»‹ç”¨ï¼‰
           botSay('<button class="choice-btn" data-next="contact_direct">å•ã„åˆã‚ã›</button>', true);
           
           afterBotReply(btn.textContent);
        } catch(err) {
           botSay('ã”ã‚ã‚“ã­ã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¡ã‚ƒã£ãŸã€‚');
        }
        return;
      }

      if (next && KB[next]) {
        userSay(btn.textContent);
        botSay(KB[next], true); 
        afterBotReply(btn.textContent);
      }
    });

    function topicKey(text){
      const t = text.replace(/\s+/g,'').toLowerCase();
      if (t.includes('æ–™é‡‘')||t.includes('price')) return 'price';
      if (t.includes('å°å…¥')||t.includes('flow')||t.includes('å§‹ã‚')) return 'flow';
      if (t.includes('äº‹ä¾‹')||t.includes('case')) return 'cases';
      if (t.includes('ã‚¤ãƒ³ã‚¹ã‚¿')||t.includes('instagram')) return 'insta';
      if (t.includes('æ±‚äºº')||t.includes('æ¡ç”¨')||t.includes('åºƒå ±')) return 'recruit';
      return 'service';
    }
    let lastTopic = ''; let sameCount = 0;
    function afterBotReply(userText){
      const k = topicKey(userText);
      if (k === lastTopic) sameCount += 1; else { lastTopic = k; sameCount = 1; }
      if (sameCount >= 2) { botSay('ã‚ˆã‹ã£ãŸã‚‰HOAPã«ç›¸è«‡ã—ã¦ã¿ãªã„ï¼Ÿå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã‚’æŠ¼ã—ã¦ã­ï¼'); sameCount = 0; }
    }

    const API_ORIGIN = 'https://hoap-ai-chatbot.vercel.app';

    async function ask(question) {
      const res = await fetch('/api/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: question }),
      });
      let data = null;
      try { data = await res.json(); } catch {}
      if (!res.ok) {
        const msg = (data && (data.detail || data.error)) || res.status + ' ' + res.statusText;
        throw new Error(msg);
      }
      if (data && data.error) { throw new Error(data.detail || data.error); }
      return (data && data.reply) ? data.reply : '';
    }

    async function handleInput() {
      const raw = inputEl.value;
      const text = raw.trim();
      if (!text) return;
      userSay(text);
      inputEl.value = '';
      setTimeout(() => { inputEl.value = ''; inputEl.focus(); }, 0);
      try {
        const a = await ask(text);
        if (a) {
          await splitAndShow(a);
        } else {
          botSay('ï¼ˆç©ºã®è¿”ç­”ï¼‰');
        }
        afterBotReply(text);
      } catch (e) {
        botSay('ã‚¨ãƒ©ãƒ¼: ' + (e && e.message ? e.message : e));
      }
    }

    async function splitAndShow(text) {
      const MAX_LEN = 225;
      const lines = text.split('\n');
      const chunks = [];
      let current = '';

      for (const line of lines) {
        // éå¸¸ã«é•·ã„1è¡ŒãŒ225æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã‚‚è€ƒæ…®ã™ã¹ãã ãŒã€ä»Šå›ã¯æ”¹è¡ŒåŒºåˆ‡ã‚Šå‰æ
        // ã‚‚ã—currentå˜ä½“ã§ã™ã§ã«MAXã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆãªã©ã¯å¼·åˆ¶åˆ†å‰²ãŒå¿…è¦ã ãŒç°¡æ˜“å®Ÿè£…ã¨ã™ã‚‹
        if ((current + line).length > MAX_LEN) {
          if (current) chunks.push(current);
          current = line + '\n';
        } else {
          current += line + '\n';
        }
      }
      if (current) chunks.push(current);

      let lastMsg = null;
      for (let i = 0; i < chunks.length; i++) {
        if (i > 0) {
          await new Promise(r => setTimeout(r, 3000));
          if (lastMsg) lastMsg.remove();
        }
        botSay(chunks[i].trim());
        lastMsg = bodyEl.lastElementChild; 
      }
    }

    sendBtn.addEventListener('click', () => { handleInput(); });
    let composing = false;
    inputEl.addEventListener('compositionstart', () => { composing = true; });
    inputEl.addEventListener('compositionend',   () => { composing = false; });
    inputEl.addEventListener('keydown', e => {
      if (composing) return;
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        handleInput();
      }
    });

    quickEl.addEventListener('click', e => {
      const btn = e.target.closest('button'); if (!btn) return;
      const intent = btn.dataset.intent; if (!intent) return;
      if (intent === 'contact') { window.location.href = 'https://hoap-inc.jp/contact'; return; }
      answer(intent);
      afterBotReply(btn.textContent);
    });

    function openChat() {
      dialog.style.display = '';      // inlineã‚’è§£é™¤
      dialog.classList.add('open');   // CSSã§display:flexã¸
      if (!bodyEl.dataset.welcomed) {
        botSay('ã“ã‚“ã«ã¡ã¯ï¼ã»ãƒ¼ã·ã¡ã‚ƒã‚“ã ã‚ˆã€‚æ°—ã«ãªã‚‹ã¨ã“ã‚ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã­ï¼');
        bodyEl.dataset.welcomed = '1';
      }
      placeMascot();
      syncMascotWithScroll();
      inputEl.focus();
    }
    function closeChat() {
      dialog.classList.remove('open');
ã€€    dialog.style.display = 'none'; // ç¢ºå®Ÿã«é–‰ã˜ã‚‹
  }

    // å¤–ã®ãƒœã‚¿ãƒ³ã¯å®Œå…¨ã«å‰Šé™¤
const outerLauncher = document.querySelector('.hoap-chat-launcher');
if (outerLauncher) outerLauncher.remove(); // display:noneã˜ã‚ƒãªãã¦å‰Šé™¤ï¼

// Shadowå†…ã®ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆ
const innerLauncher = shadow.querySelector('.hoap-chat-launcher');
    innerLauncher.addEventListener('click', openChat);
    innerLauncher.addEventListener('touchend', openChat); // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚‚è¿½åŠ 
    closeBtn.addEventListener('click', closeChat);
    window.addEventListener('resize', placeMascot);
    bodyEl.addEventListener('scroll', syncMascotWithScroll);

    // UIé«˜ã•ç›£è¦–
    function syncMascotPos() {
      const h = (quickEl.offsetHeight || 0) + (inputEl.offsetHeight || 0);
      dialog.style.setProperty('--uiH', h + 'px');
    }
    const ro = new ResizeObserver(syncMascotPos);
    ro.observe(quickEl);
    ro.observe(inputEl);
    syncMascotPos(); // åˆæœŸå®Ÿè¡Œ
  </script>
</body>
